<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>{{ playlist.name }} – Playlist</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
:root {
    --accent: #1db954;
    --accent-hover: #1ed760;
    --bg: #121212;
    --sidebar: #000;
    --card-bg: #1e1e1e;
    --text-muted: #b3b3b3;
}

body {
    background-color: var(--bg);
    color: white;
    font-family: Arial, sans-serif;
    margin: 0;
    padding-bottom: 120px;
    display: flex;
}

/* SIDEBAR */
.sidebar {
    width: 230px;
    background: var(--sidebar);
    height: 100vh;
    position: fixed;
    left: 0;
    top: 0;
    padding: 20px;
    overflow-y: auto;
    border-right: 1px solid #222;
}

.sidebar h2 {
    margin-top: 10px;
    font-size: 18px;
    color: var(--accent);
}

.sidebar a {
    display: block;
    padding: 8px 0;
    font-size: 14px;
    text-decoration: none;
    color: white;
}
.sidebar a:hover {
    color: var(--accent-hover);
}

/* MAIN */
.main {
    margin-left: 250px;
    padding: 20px;
    width: calc(100% - 250px);
}

/* HEADER */
.playlist-header {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-bottom: 30px;
}

.playlist-cover {
    width: 180px;
    height: 180px;
    border-radius: 10px;
    object-fit: cover;
    background: #222;
}

.playlist-info h1 {
    margin: 0;
    font-size: 40px;
}

.playlist-info p {
    margin: 8px 0;
    color: var(--text-muted);
}

.play-buttons {
    display: flex;
    gap: 15px;
    margin-top: 10px;
}

/* BUTTONS (same style as index) */
.player-button {
    width: 48px;
    height: 48px;
    background: #292929;
    color: white;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 0;
    transition: 0.15s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}
.player-button:hover {
    background: #343434;
    transform: scale(1.08);
}
#play-all {
    background: var(--accent);
    box-shadow: 0 0 10px rgba(29,185,84,0.6);
}

/* icon shapes */
.player-button::before { content:''; display:block; }

.btn-playlist-play::before {
    border-style: solid;
    border-width: 9px 0 9px 15px;
    border-color: transparent transparent transparent #000000;
    margin-left: 3px;
}

.btn-shuffle::before {
    width: 18px;
    height: 2px;
    background: #ffffff;
    box-shadow: 0 5px 0 0 #ffffff, 0 -5px 0 0 #ffffff;
}
.btn-repeat::before {
    width: 16px;
    height: 10px;
    border-radius: 8px;
    border: 2px solid #ffffff;
    border-top-color: transparent;
}

/* TABLE */
.track-list {
    width: 100%;
    border-collapse: collapse;
}

.track-list tr {
    border-bottom: 1px solid #262626;
}

.track-list td {
    padding: 14px 8px;
    vertical-align: middle;
}

.track-row:hover {
    background: #1c1c1c;
    cursor: pointer;
}

.track-thumb {
    width: 50px;
    height: 50px;
    border-radius: 6px;
    object-fit: cover;
}

.remove-btn {
    padding: 6px 10px;
    background: #b30000;
    border: none;
    color: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 13px;
}
.remove-btn:hover {
    background: #cc0000;
}

select {
    padding: 6px;
    background: #222;
    border-radius: 5px;
    border: none;
    color: white;
    cursor: pointer;
    margin-top: 4px;
}

/* PLAYER BAR (same as index) */
#player {
    position: fixed;
    left: 250px;
    bottom: 0;
    width: calc(100% - 250px);
    background: #181818;
    padding: 10px;
    display: flex;
    align-items: center;
    gap: 15px;
    border-top: 1px solid #333;
}

#player-thumb {
    width: 60px;
    height: 60px;
    border-radius: 6px;
    object-fit: cover;
}
.player-info h4 {
    margin: 0;
    font-size: 15px;
}
.player-info p {
    margin: 2px 0 0;
    font-size: 12px;
    color: var(--text-muted);
}

/* player buttons */
.player-button-global {
    width: 42px;
    height: 42px;
    background: #2c2c2c;
    color: white;
    border-radius: 50%;
    border: none;
    cursor: pointer;
    font-size: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
    transition: 0.15s ease;
}
.player-button-global::before { content:''; display:block; }
.player-button-global:hover {
    background: #363636;
    transform: scale(1.08);
}

.btn-prev::before {
    border-style: solid;
    border-width: 6px 8px 6px 0;
    border-color: transparent #ffffff transparent transparent;
    box-shadow: -6px 0 0 0 #ffffff;
}
.btn-next::before {
    border-style: solid;
    border-width: 6px 0 6px 8px;
    border-color: transparent transparent transparent #ffffff;
    box-shadow: 6px 0 0 0 #ffffff;
}
#play-pause.btn-play::before {
    border-style: solid;
    border-width: 8px 0 8px 14px;
    border-color: transparent transparent transparent #000000;
    margin-left: 4px;
}
#play-pause.btn-pause::before {
    width: 12px;
    height: 14px;
    box-shadow: 0 0 0 3px #000000, 10px 0 0 3px #000000;
}
.btn-global-shuffle::before {
    width: 18px;
    height: 2px;
    background: #ffffff;
    box-shadow: 0 5px 0 0 #ffffff, 0 -5px 0 0 #ffffff;
}
.btn-global-repeat::before {
    width: 16px;
    height: 10px;
    border-radius: 8px;
    border: 2px solid #ffffff;
    border-top-color: transparent;
}

#play-pause {
    background: var(--accent);
    width: 50px;
    height: 50px;
    box-shadow: 0 0 10px rgba(29,185,84,0.6);
}

/* Progress bar */
#progress-container {
    flex: 2;
    height: 6px;
    background: #404040;
    border-radius: 5px;
    cursor: pointer;
}
#progress {
    height: 100%;
    width: 0;
    border-radius: 5px;
    background: var(--accent);
}
#time {
    width: 60px;
    text-align: center;
    font-size: 13px;
}

/* Volume control */
#volume-box {
    display: flex;
    align-items: center;
    gap: 6px;
    width: 130px;
}
#volume-slider {
    width: 100%;
    cursor: pointer;
}
.volume-icon {
    width: 14px;
    height: 14px;
    border-radius: 2px;
    border: 2px solid #ffffff;
    border-right: none;
    position: relative;
}
.volume-icon::after {
    content: '';
    position: absolute;
    right: -4px;
    top: 2px;
    border-style: solid;
    border-width: 4px 0 4px 6px;
    border-color: transparent transparent transparent #ffffff;
}

/* MOBILE */
@media (max-width: 850px) {
    .sidebar {
        display: none;
    }
    .main {
        margin-left: 0;
        width: 100%;
    }
    #player {
        left: 0;
        width: 100%;
    }
    .playlist-header {
        flex-direction: column;
        align-items: center;
        text-align: center;
    }
}
</style>
</head>
<body>

<!-- SIDEBAR -->
<div class="sidebar">
    <h2>Your Playlists</h2>

    <a href="{{ url_for('playlist_list') }}">All Playlists</a>

    {% for p in playlists %}
        <a href="{{ url_for('playlist_view', playlist_id=p.id) }}">{{ p.name }}</a>
    {% endfor %}

    <br><br>
    <a href="{{ url_for('index') }}">⬅ Back to Library</a>
</div>

<!-- MAIN -->
<div class="main">

    <div class="playlist-header">

        {% if tracks|length > 0 %}
            <img src="{{ url_for('thumbnail', track_id=tracks[0].id) }}"
                 class="playlist-cover">
        {% else %}
            <img src="https://via.placeholder.com/180"
                 class="playlist-cover">
        {% endif %}

        <div class="playlist-info">
            <h1>{{ playlist.name }}</h1>
            <p>{{ tracks|length }} tracks</p>

            <div class="play-buttons">
                <button class="player-button btn-playlist-play" id="play-all" onclick="playPlaylist()"></button>
                <button class="player-button btn-shuffle" onclick="toggleShuffle()"></button>
                <button class="player-button btn-repeat" onclick="toggleRepeat()"></button>
            </div>

        </div>

    </div>

    <!-- TRACK TABLE -->
    <table class="track-list">
        {% for t in tracks %}
        <tr class="track-row" onclick="playFromIndex({{ loop.index0 }})">
            <td>
                <img class="track-thumb" src="{{ url_for('thumbnail', track_id=t.id) }}">
            </td>

            <td>
                <strong>{{ t.name }}</strong><br>
                <span style="color: var(--text-muted);">{{ t.artist }}</span>

                <!-- ADD TO PLAYLIST -->
                <select onchange="addToPlaylist(this.value, {{ t.id }}); event.stopPropagation();">
                    <option value="">Add to playlist</option>
                    {% for p in playlists %}
                        <option value="{{ p.id }}">{{ p.name }}</option>
                    {% endfor %}
                </select>
            </td>

            <td>
                <button class="remove-btn"
                onclick="event.stopPropagation(); window.location.href='{{ url_for('playlist_remove', playlist_id=playlist.id, track_id=t.id) }}'">
                    Remove
                </button>
            </td>
        </tr>
        {% endfor %}
    </table>

</div>

<!-- PLAYER -->
<div id="player">
    <img id="player-thumb" src="https://via.placeholder.com/60" alt="thumb">

    <div class="player-info">
        <h4 id="player-title">Nothing Playing</h4>
        <p id="player-artist">---</p>
    </div>

    <button class="player-button-global btn-prev" onclick="prevTrack()"></button>
    <button class="player-button-global btn-play" id="play-pause" onclick="togglePlay()"></button>
    <button class="player-button-global btn-next" onclick="nextTrack()"></button>

    <button class="player-button-global btn-global-shuffle" onclick="toggleShuffle()"></button>
    <button class="player-button-global btn-global-repeat" onclick="toggleRepeat()"></button>

    <div id="volume-box">
        <div class="volume-icon"></div>
        <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="1">
    </div>

    <div id="progress-container" onclick="setProgress(event)">
        <div id="progress"></div>
    </div>

    <div id="time">0:00</div>
</div>

<audio id="audio"></audio>

<script>
    let audio = document.getElementById("audio");
    let playBtn = document.getElementById("play-pause");
    let progressBar = document.getElementById("progress");
    let timeLabel = document.getElementById("time");
    let volumeSlider = document.getElementById("volume-slider");

    audio.volume = 1;
    volumeSlider.addEventListener("input", () => {
        audio.volume = volumeSlider.value;
    });

    let currentTrackIndex = 0;
    let shuffle = false;
    let repeatTrack = false;

    let tracks = [
        {% for t in tracks %}
        {
            file: "{{ url_for('stream', track_id=t.id) }}",
            name: "{{ t.name }}",
            artist: "{{ t.artist }}",
            thumb: "{{ url_for('thumbnail', track_id=t.id) }}"
        },
        {% endfor %}
    ];

    function playFromIndex(i) {
        if (i < 0 || i >= tracks.length) return;
        currentTrackIndex = i;
        let t = tracks[i];
        playTrack(t.file, t.name, t.artist, t.thumb);
    }

    function playPlaylist() {
        if (tracks.length === 0) return;
        playFromIndex(0);
    }

    function playTrack(file, name, artist, thumb) {
        audio.src = file;
        audio.play();

        document.getElementById("player-title").textContent = name;
        document.getElementById("player-artist").textContent = artist;
        document.getElementById("player-thumb").src = thumb;

        playBtn.classList.remove('btn-play');
        playBtn.classList.add('btn-pause');
    }

    function addToPlaylist(playlist_id, track_id) {
        if (!playlist_id) return;
        window.location.href = `/playlist/${playlist_id}/add/${track_id}`;
    }

    function togglePlay() {
        if (!audio.src) {
            if (tracks.length === 0) return;
            playFromIndex(0);
            return;
        }

        if (audio.paused) {
            audio.play();
            playBtn.classList.remove('btn-play');
            playBtn.classList.add('btn-pause');
        } else {
            audio.pause();
            playBtn.classList.remove('btn-pause');
            playBtn.classList.add('btn-play');
        }
    }

    audio.addEventListener("timeupdate", () => {
        if (!audio.duration) return;
        let percent = (audio.currentTime / audio.duration) * 100;
        progressBar.style.width = percent + "%";

        let m = Math.floor(audio.currentTime / 60);
        let s = Math.floor(audio.currentTime % 60).toString().padStart(2,"0");
        timeLabel.textContent = `${m}:${s}`;
    });

    function setProgress(e) {
        const rect = e.currentTarget.getBoundingClientRect();
        const clickX = e.clientX - rect.left;
        const width = rect.width;
        if (!audio.duration) return;
        audio.currentTime = (clickX / width) * audio.duration;
    }

    function nextTrack() {
        if (tracks.length === 0) return;

        if (shuffle) {
            currentTrackIndex = Math.floor(Math.random() * tracks.length);
        } else {
            currentTrackIndex++;
            if (currentTrackIndex >= tracks.length) currentTrackIndex = 0;
        }
        playFromIndex(currentTrackIndex);
    }

    function prevTrack() {
        if (tracks.length === 0) return;
        currentTrackIndex--;
        if (currentTrackIndex < 0) currentTrackIndex = tracks.length - 1;
        playFromIndex(currentTrackIndex);
    }

    function toggleShuffle() {
        shuffle = !shuffle;
    }

    function toggleRepeat() {
        repeatTrack = !repeatTrack;
    }

    audio.addEventListener("ended", () => {
        if (repeatTrack) {
            audio.currentTime = 0;
            audio.play();
            return;
        }
        nextTrack();
    });
</script>

</body>
</html>
