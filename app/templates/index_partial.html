<header style="display:flex;justify-content:space-between;align-items:center;background:#1e1e1e;padding:10px 18px;border-radius:10px;margin:18px 18px 10px 18px;">
    <h2 style="margin:0;font-size:18px;">Welcome, {{ current_user.username }}</h2>

    <form method="get"
          onsubmit="loadPage('/library?search=' + encodeURIComponent(this.search.value)); return false;"
          style="display:flex;">
        <input type="text" name="search" value="{{ search }}"
               placeholder="Search..."
               style="padding:10px;background:#292929;color:white;border:none;border-radius:6px 0 0 6px;">
        <button style="padding:10px;background:var(--accent);border:none;border-radius:0 6px 6px 0;cursor:pointer;">
            Search
        </button>
    </form>
</header>

<div style="padding:10px 18px 20px 18px;">
    <h3 style="margin-top:0;">All Tracks</h3>

    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:18px;">

        {% for t in tracks %}
        <div style="background:#1e1e1e;padding:12px;border-radius:10px;cursor:pointer;transition:.15s;"
             onmouseover="this.style.background='#252525';"
             onmouseout="this.style.background='#1e1e1e';"
             onclick="playFromLibrary({{ loop.index0 }});">

            <img
                src="{{ url_for('stream.thumbnail', track_id=t.id) }}"
                onerror="this.style.display='none';"
                style="width:100%;height:180px;border-radius:8px;object-fit:cover;display:block;margin-bottom:8px;"
            >

            <h4 style="margin:0 0 4px;font-size:15px;">{{ t.name }}</h4>
            <p style="color:#aaa;margin:0 0 10px;font-size:12px;">{{ t.artist }}</p>

            <select
                onchange="
                    if (this.value) {
                        window.location.href = '{{ url_for('playlist.playlist_add', playlist_id='__PID__', track_id=t.id) }}'
                            .replace('__PID__', this.value);
                    }
                    event.stopPropagation();
                "
                style="width:100%;padding:6px;background:#222;color:white;border:none;border-radius:6px;font-size:12px;"
            >
                <option value="">Add to playlistâ€¦</option>
                {% for p in playlists %}
                    <option value="{{ p.id }}">{{ p.name }}</option>
                {% endfor %}
            </select>
        </div>
        {% endfor %}

    </div>
</div>

<script>
// library queue for global player
window.tracks = [
    {% for t in tracks %}
    {
        file: "{{ url_for('stream.stream', track_id=t.id) }}",
        name: "{{ t.name|e }}",
        artist: "{{ t.artist|e }}",
        thumb: "{{ url_for('stream.thumbnail', track_id=t.id) }}"
    }{% if not loop.last %},{% endif %}
    {% endfor %}
];

window.currentIndex = 0;

window.playFromLibrary = function(idx) {
    window.currentIndex = idx;
    const t = window.tracks[idx];
    playTrack(t.file, t.name, t.artist, t.thumb);
};
</script>
