<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Mini Spotify</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root {
  --accent:#1db954;
  --bg:#121212;
  --sidebar:#000;
  --muted:#b3b3b3;
}
body {
  margin:0;
  background:var(--bg);
  color:#fff;
  font-family:Arial,sans-serif;
  display:flex;
}

/* SIDEBAR */
#sidebar {
  width:240px;
  background:var(--sidebar);
  height:100vh;
  position:fixed;
  padding:16px;
  border-right:1px solid #222;
  overflow-y:auto;
}
#sidebar h2 { color:var(--accent); font-size:18px; }

.playlist-item {
  display:flex;
  align-items:center;
  gap:8px;
  padding:6px 0;
}
.playlist-thumb {
  width:32px;
  height:32px;
  border-radius:4px;
  background:#222;
  object-fit:cover;
}
.playlist-name {
  flex:1;
  cursor:pointer;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
.playlist-delete {
  color:#e44;
  cursor:pointer;
  background:none;
  border:none;
}

/* MAIN */
#content {
  margin-left:240px;
  width:calc(100% - 240px);
  padding-bottom:120px;
}

/* PLAYER */
#player {
  position:fixed;
  bottom:0;
  left:240px;
  width:calc(100% - 240px);
  background:#181818;
  padding:12px;
  display:flex;
  align-items:center;
  gap:12px;
  border-top:1px solid #333;
}
#player-thumb {
  width:56px;
  height:56px;
  border-radius:6px;
  object-fit:cover;
}
.btn {
  width:40px;
  height:40px;
  border-radius:50%;
  background:#2c2c2c;
  border:none;
  color:white;
  cursor:pointer;
}
#play-btn {
  background:var(--accent);
  color:black;
}
#progress-container {
  flex:2;
  height:6px;
  background:#444;
  border-radius:5px;
  cursor:pointer;
}
#progress {
  height:6px;
  background:var(--accent);
  width:0%;
}
#time-label {
  font-size:12px;
  width:50px;
  text-align:right;
}
@media (max-width:900px) {
  #sidebar { display:none; }
  #content, #player {
    margin-left:0;
    width:100%;
    left:0;
  }
}
</style>
</head>

<body>

<!-- SIDEBAR -->
<div id="sidebar">
  <h2>Your Playlists</h2>

  <div id="playlist-container">
    {% for p in playlists %}
    <div class="playlist-item"
         data-id="{{ p.id }}">
      {% if p.thumb_track_id %}
        <img class="playlist-thumb"
             src="{{ url_for('stream.thumbnail', track_id=p.thumb_track_id) }}">
      {% else %}
        <img class="playlist-thumb"
             src="/static/img/placeholder.png">
      {% endif %}

      <div class="playlist-name"
           data-action="open-playlist">
        {{ p.name }}
      </div>

      <button class="playlist-delete"
              data-action="delete-playlist">
        ✖
      </button>
    </div>
    {% endfor %}
  </div>

  <hr>

  <form id="create-playlist-form">
    <input id="playlist-name"
           required
           placeholder="New playlist">
    <button type="submit">+</button>
  </form>
</div>

<!-- MAIN -->
<div id="content">
  {% include "index_partial.html" %}
</div>

<!-- PLAYER -->
<div id="player">
  <img id="player-thumb"
       src="/static/img/placeholder.png">

  <div>
    <div id="p-title">Nothing Playing</div>
    <div id="p-artist" style="font-size:12px;color:var(--muted)">—</div>
  </div>

  <button class="btn" id="prev">⏮</button>
  <button class="btn" id="play-btn">▶</button>
  <button class="btn" id="next">⏭</button>

  <input type="range" id="volume" min="0" max="1" step="0.01" value="1">

  <div id="progress-container">
    <div id="progress"></div>
  </div>

  <span id="time-label">0:00</span>
</div>

<audio id="audio"></audio>

<script>
/* ================= PLAYER STATE ================= */
const state = {
  tracks: [],
  index: 0,
  shuffle: false,
  repeat: false
};

const audio = document.getElementById("audio");

/* ================= CORE FUNCTIONS ================= */
function playTrackAt(index) {
  if (!state.tracks[index]) return;

  state.index = index;
  const t = state.tracks[index];

  audio.src = t.file;
  audio.play();

  document.getElementById("p-title").textContent = t.name;
  document.getElementById("p-artist").textContent = t.artist || "";
  document.getElementById("player-thumb").src =
    t.thumb || "/static/img/placeholder.png";

  document.getElementById("play-btn").textContent = "⏸";
}

function togglePlay() {
  if (audio.paused) {
    audio.play();
    playBtn.textContent = "⏸";
  } else {
    audio.pause();
    playBtn.textContent = "▶";
  }
}

function nextTrack() {
  if (!state.tracks.length) return;
  state.index = (state.index + 1) % state.tracks.length;
  playTrackAt(state.index);
}

function prevTrack() {
  if (!state.tracks.length) return;
  state.index =
    (state.index - 1 + state.tracks.length) % state.tracks.length;
  playTrackAt(state.index);
}

/* ================= EVENTS ================= */
document.getElementById("play-btn").onclick = togglePlay;
document.getElementById("next").onclick = nextTrack;
document.getElementById("prev").onclick = prevTrack;

document.getElementById("volume").oninput =
  e => audio.volume = e.target.value;

audio.ontimeupdate = () => {
  if (!audio.duration) return;
  progress.style.width =
    (audio.currentTime / audio.duration) * 100 + "%";

  const m = Math.floor(audio.currentTime / 60);
  const s = Math.floor(audio.currentTime % 60)
            .toString().padStart(2,"0");
  timeLabel.textContent = `${m}:${s}`;
};

audio.onended = () => {
  state.repeat ? playTrackAt(state.index) : nextTrack();
};

/* ================= SPA NAV ================= */
function loadPage(url) {
  fetch(url)
    .then(r => r.text())
    .then(html => {
      document.getElementById("content").innerHTML = html;
    });
}

/* ================= SIDEBAR EVENTS ================= */
document.getElementById("playlist-container")
  .addEventListener("click", e => {

  const item = e.target.closest(".playlist-item");
  if (!item) return;

  const id = item.dataset.id;

  if (e.target.dataset.action === "open-playlist") {
    loadPage(`/playlist/${id}`);
  }

  if (e.target.dataset.action === "delete-playlist") {
    if (confirm("Delete playlist?")) {
      location.href = `/playlist/${id}/delete`;
    }
  }
});

/* ================= PLAYLIST API ================= */
window.playAll = tracks => {
  if (!tracks?.length) return;
  state.tracks = tracks;
  playTrackAt(0);
};

window.playFromIndex = (tracks, index) => {
  if (!tracks?.[index]) return;
  state.tracks = tracks;
  playTrackAt(index);
};
</script>

</body>
</html>
